"use strict";(self.webpackChunkdlxl=self.webpackChunkdlxl||[]).push([[624],{65881:(P,F,l)=>{l.d(F,{v:()=>m});var D=l(15861),I=l(94650),f=l(1768),E=l(92358),v=l(94559);let m=(()=>{class A{constructor(S,C,B){this.cmis4SV=S,this.httpSV=C,this.loadSV=B,this.user=JSON.parse(localStorage.getItem("USERCMIS"))}updateLichGhi(S){this.loadSV.load("updateLichGhi");let C=S.map(B=>({...B,_id:B.MA_SOGCS}));return this.httpSV.put("lich-ghi-chi-so/multi",C,"")}ExcuteNhapCSDoiGia(S){var C=this;return(0,D.Z)(function*(){return C.cmis4SV.cmis4Request("https://cmis-api.evnspc.vn/serviceChiSoKHang/ExcuteNhapCSDoiGia","/serviceChiSoKHang/ExcuteNhapCSDoiGia",S).then(u=>(console.log(u),u))})()}getChiso_DGia(S){var C=this;return(0,D.Z)(function*(){return C.cmis4SV.cmis4Request("https://cmis-api.evnspc.vn/serviceChiSoKHang/getChiso_DGia","/serviceChiSoKHang/getChiso_DGia",S).then(u=>(console.log(u),u))})()}get_Lich_SoGCS(S){var C=this;return(0,D.Z)(function*(){return C.cmis4SV.cmis4Request("https://cmis-api.evnspc.vn/serviceChiSoKHang/get_Lich_SoGCS","/serviceChiSoKHang/get_Lich_SoGCS",S).then(u=>(console.log(u),u))})()}getChiso(S,C){var B=this;return(0,D.Z)(function*(){return B.cmis4SV.cmis4Request("https://cmis-api.evnspc.vn/serviceChiSoKHang/getChiso","/serviceChiSoKHang/getChiso",C).then(p=>(console.log(p),p))})()}getDDoSoGCS(S){var C=this;return(0,D.Z)(function*(){return C.cmis4SV.cmis4Request("https://cmis-api.evnspc.vn/serviceHopDong/getDDoSoGCS","/serviceHopDong/getDDoSoGCS",S).then(u=>(console.log(u),u))})()}getSoGCSByListSo(S){var C=this;return(0,D.Z)(function*(){return C.cmis4SV.cmis4Request("https://cmis-api.evnspc.vn/serviceDanhMuc/getSoGCSByListSo","/serviceDanhMuc/getSoGCSByListSo",{TEN_DANH_MUC:"D_SOGCS",MA_DVIQLY:C.user.SUBDIVISIONID,PARAM:[S]}).then(p=>(console.log(p),p))})()}get_gcslichgcsByMaSogcs(S,C){var B=this;return(0,D.Z)(function*(){return B.cmis4SV.cmis4Request("https://cmis-api.evnspc.vn/serviceChiSoKHang/get_gcslichgcsByMaSogcs","/serviceChiSoKHang/get_gcslichgcsByMaSogcs",C).then(p=>p[0])})()}}return A.\u0275fac=function(S){return new(S||A)(I.LFG(f.a),I.LFG(E.a),I.LFG(v.b))},A.\u0275prov=I.Yz7({token:A,factory:A.\u0275fac,providedIn:"root"}),A})()},33015:(P,F,l)=>{l.d(F,{G9:()=>u,fq:()=>M});var D=l(15861),I=l(24006),f=l(54004),E=l(75625),v=l(70262),m=l(94650),A=l(25555),T=l(92358),S=l(11147),C=l(12012),B=l(58441);let M=(()=>{class c{constructor(a,t,e,s,i){this.plus=a,this.httpSV=t,this.formSV=e,this.idbSV=s,this.sheetdbSV=i,this.header={MA_KHANG:"M\xe3 kh\xe1ch h\xe0ng",TEN_KHANG:"T\xean kh\xe1ch h\xe0ng",STIEN_DCOC:"S\u1ed1 ti\u1ec1n",HTHUC_DBAO_HDONG:"H\xecnh th\u1ee9c b\u1ea3o \u0111\u1ea3m h\u1ee3p \u0111\u1ed3ng",SERI_CHUNG_THU:"Th\xf4ng tin Ch\u1ee9ng th\u01b0",HLUC_DENNGAY:"H\u1ea1n h\u1ee3p \u0111\u1ed3ng",DTHOAI_DD:"\u0110i\u1ec7n tho\u1ea1i",DCHI_DDIEN:"\u0110\u1ecba ch\u1ec9",NGAY_BAO_CO:"Ng\xe0y b\xe1o c\xf3",TRANG_THAI:"Tr\u1ea1ng th\xe1i",GHI_CHU:"Ghi ch\xfa"},this.main=this.formSV.fb.group({MA_KHANG:["",[I.kI.required,I.kI.minLength(1)]],TEN_KHANG:["",[I.kI.required,I.kI.minLength(1)]],STIEN_DCOC:[0,[I.kI.required,I.kI.minLength(1)]],HTHUC_DBAO_HDONG:["",[I.kI.required,I.kI.minLength(1)]],SERI_CHUNG_THU:["",[]],HLUC_DENNGAY:["",[]],HLUC_TUNGAY:["",[]],DTHOAI_DD:["",[]],DCHI_DDIEN:["",[]],NGAY_BAO_CO:["",[]],TRANG_THAI:["",[I.kI.required,I.kI.minLength(1)]],GHI_CHU:["",[]],HLUC_BAO_DAM:["",[]]}),this.user=null,this.db=null,this.dbName="kinh-doanh",this.api="ky-quy",this.title="B\u1ea3o \u0111\u1ea3m h\u1ee3p \u0111\u1ed3ng",this.isExplain=!1,this.E_HTHUC_DBAO_HDONG=p,this.E_TRANG_THAI=u,this.logSheetID="1iKOd7FnQdPFDdN88hH1Fdf-a4e9_CttbjgYDACZ1MD8",this.plus.setTiTle(this.title),this.initDB()}initDB(){if(!this.db)return this.idbSV.IDB_InitDB(this.dbName).subscribe(a=>{this.db=a})}checkForm(){let a=this.formSV.getErrValidateFormV2(this.main,this.header);if(a.length>2)return this.plus.alertError(`${a}`)}sync(){return this.httpSV.updateLocalDB(this.db,this.api,window.max.unit+"-"+this.api)}getAllIDB(){return this.idbSV.IDB_DB_GetAll(this.db,this.api)}getByPK(a){var t=this;return(0,D.Z)(function*(){return new Promise((e,s)=>{t.idbSV.IDB_InitDB(t.dbName).subscribe(i=>{t.db=i,t.idbSV.IDB_DB_GetAllByIndexKey(t.db,t.api,"MA_KHANG","=",a).then(n=>{e(n)})})})})()}getApi(){return this.httpSV.get(this.api).pipe((0,f.U)(a=>(console.log(a),this.idbSV.IDB_DB_Add(this.db,this.api,a.data).then(()=>{this.plus.alertMatSnackBar("C\u1eadp nh\u1eadt d\u1eef li\u1ec7u xong!")}),a.data)),(0,E.X)(1),(0,v.K)(a=>{throw console.log(a),a}))}addApi(a){return this.httpSV.post(this.api,a).pipe((0,f.U)(t=>(this.sheetdbSV.addMany(this.logSheetID,"Data",[a]),t.data)),(0,E.X)(1),(0,v.K)(t=>{throw console.log(t),t}))}updateApi(a){this.main.patchValue(a);let t=this.formSV.getErrValidateFormV2(this.main,this.header);if(!(t.length>2))return this.sheetdbSV.addLog("ky-quy",[a]).then(()=>{console.log("log")}),this.httpSV.put(this.api,a,"").pipe((0,f.U)(e=>e.data),(0,E.X)(1),(0,v.K)(e=>{throw console.log(e),e}));this.plus.alertError(`${t}`)}deleteApi(a){return this.httpSV.disable(this.api,a)}}return c.\u0275fac=function(a){return new(a||c)(m.LFG(A.T),m.LFG(T.a),m.LFG(S.o),m.LFG(C.F),m.LFG(B.F))},c.\u0275prov=m.Yz7({token:c,factory:c.\u0275fac,providedIn:"root"}),c})();var u=(()=>{return(c=u||(u={})).CHUATH="Ch\u01b0a th\u1ef1c hi\u1ec7n",c.DA_THUC_HIEN="\u0110\xe3 th\u1ef1c hi\u1ec7n",c.DA_BAO_CO="\u0110\xe3 \u0111\u1ed1i so\xe1t",c.DA_THANH_LY="\u0110\xe3 thanh l\xfd",c.DA_HOAN_TRA="\u0110\xe3 ho\xe0n tr\u1ea3",c.DA_CHUYEN_TNK="\u0110\xe3 chuy\u1ec3n thu nh\u1eadp kh\xe1c",c.DA_NHAN_CT="\u0110\xe3 nh\u1eadn ch\u1ee9ng th\u01b0",u;var c})(),p=(()=>{return(c=p||(p={})).KYQUY="K\xfd qu\u1ef9 s\u1eed d\u1ee5ng \u0111i\u1ec7n",c.BAODAM="B\u1ea3o \u0111\u1ea3m ng\xe2n h\xe0ng",p;var c})()},44071:(P,F,l)=>{l.d(F,{CO:()=>u,fn:()=>M});var D=l(15861),I=l(15439),f=l.n(I),E=l(94650),v=l(12012),m=l(92358),A=l(94559),T=l(48878),S=l(58441),C=l(25555),B=l(1768);let M=(()=>{class c{constructor(a,t,e,s,i,n,o){this.idbSV=a,this.httpSV=t,this.loadSV=e,this.fbSV=s,this.sheetdbSV=i,this.plus=n,this.cmis4SV=o,this.user=null,this.USERCMIS=this.cmis4SV.getUser(),this.db=null,this.dbName="kinh-doanh",this.api="ghi-chi-so",this.apilich="lich-ghi-chi-so",this.table=f()().subtract(10,"days").format("YYMM"),this.sheetID="1X9NIeAsXEPJ8LG8Vr-KPN7Wn9uLiMqxNcM0fwdjXHIs",this.kyGCS=f()().subtract(10,"days").format("YY/MM"),this.kyGCSTruoc=f()().subtract(1,"month").format("YY/MM"),this.thang=f()().subtract(10,"days").format("MM"),this.nam=f()().subtract(10,"days").format("YYYY"),this.dmCapDienAp=[{maCapda:"1",moTa:" ",sttHthi:1,tentatCapda:" ",tenCapda:"D\u01b0\u1edbi 380V",trangThai:1,_persistence_fetchGroup:null},{maCapda:"2",moTa:" ",sttHthi:1,tentatCapda:" ",tenCapda:"T\u1eeb 380V \u0111\u1ebfn d\u01b0\u1edbi 6kV",trangThai:1,_persistence_fetchGroup:null},{maCapda:"3",moTa:" ",sttHthi:1,tentatCapda:" ",tenCapda:"T\u1eeb 6kV \u0111\u1ebfn d\u01b0\u1edbi 20kV",trangThai:1,_persistence_fetchGroup:null},{maCapda:"4",moTa:" ",sttHthi:1,tentatCapda:" ",tenCapda:"T\u1eeb 20kV \u0111\u1ebfn d\u01b0\u1edbi 22kV",trangThai:1,_persistence_fetchGroup:null},{maCapda:"5",moTa:" ",sttHthi:1,tentatCapda:" ",tenCapda:"T\u1eeb 22kV \u0111\u1ebfn d\u01b0\u1edbi 35kV",trangThai:1,_persistence_fetchGroup:null},{maCapda:"6",moTa:" ",sttHthi:1,tentatCapda:" ",tenCapda:"35kV",trangThai:1,_persistence_fetchGroup:null},{maCapda:"7",moTa:" ",sttHthi:1,tentatCapda:" ",tenCapda:"Tr\xean 35kV \u0111\u1ebfn d\u01b0\u1edbi 110kV",trangThai:1,_persistence_fetchGroup:null},{maCapda:"8",moTa:" ",sttHthi:1,tentatCapda:" ",tenCapda:"T\u1eeb 110kV tr\u1edf l\xean",trangThai:1,_persistence_fetchGroup:null},{maCapda:"9",moTa:" ",sttHthi:1,tentatCapda:" ",tenCapda:"Tr\xean 220kV",trangThai:1,_persistence_fetchGroup:null}]}delKyTruoc(){return this.idbSV.IDB_DB_DeleteAllKeepByIndex(this.db,this.api,"KYCS",this.kyGCS).then(()=>{console.log("delKyTruoc",this.kyGCS)})}ghiDuLieu(a,t){var e=this;return(0,D.Z)(function*(){let s=yield e.cmis4SV.get_gcslichgcsByMaSogcs(a,e.thang,e.nam),i=f()(s.ngayDky).format("DD/MM/YYYY"),n=f()(s.ngayCky).format("DD/MM/YYYY"),o={KY:"1",THANG:+e.thang,NAM:+e.nam,MA_SOGCS:a,MA_DVIQLY:"PK0500",THANG_HT:+e.thang,NAM_HT:+e.nam,NGAY_DKY:i,NGAY_CKY:n,IS_DINH_KY:1},_=yield e.cmis4SV.getDDoSoGCS(o),g={KY:"1",THANG:+e.thang,NAM:+e.nam,MA_SOGCS:a,MA_DVIQLY:"PK0500",NGAY_CKY:n,LST_DDO:_,IS_CHUANHAPCSO:!0,IS_CHOTCS:!1},h=yield e.cmis4SV.getChiso(g);if("TYPE"in h)return e.plus.alertWarning("Kh\xf4ng c\xf3 d\xf2ng d\u1eef li\u1ec7u tr\xean CMIS c\u1ea7n thao t\xe1c");let d=[],O=0;for(let V=0;V<h.length;V++){let b,r=h[V];for(let H=0;H<t.length;H++){let L=t[H];if(L.MA_KHANG==r.MA_KHANG&&L.BCS==r.BCS&&L.CHISO_MOI&&L.CHISO_MOI.toString().trim().length>0&&+L.CHISO_MOI>+r.CHISO_CU){b=+L.CHISO_MOI,console.log(L.MA_KHANG,L.CHISO_MOI);break}}r.SLUONG_THAO=r.SLUONG_THAO&&r.SLUONG_THAO.length>0?r.SLUONG_THAO:"0",r.STT_GOC=r.STT;const K=e.dmCapDienAp.filter(H=>H.maCapda===r.MA_CAPDA).map(H=>H.tenCapda);r.TEN_CAPDA=K||"",r.MA_CNANG="54",r.MA_DVICTREN="PK",r.NGUOI_SUA=e.USERCMIS.USERNAME,r.NGUOI_TAO=e.USERCMIS.USERNAME,r.NGAY_CKY=n,r.NGAY_DKY=i,f()(i).toDate()>f()(n).toDate()&&(r.NGAY_DKY=r.NGAY_CKY),r.DMLTYPE_CS="",r.CHISO_CU=r.CHISO_CU&&r.CHISO_CU.length>0?r.CHISO_CU:"0",r.SLUONG_TTIEP=r.SLUONG_TTIEP&&r.SLUONG_TTIEP.length>0?r.SLUONG_TTIEP:"0",b>0?(r.CHISO_MOI=b.toString(),r.DMLTYPE="Insert",r.SAN_LUONG=(parseFloat(r.CHISO_MOI)-parseFloat(r.CHISO_CU)).toString(),r.NGAY_PMAX=r.NGAY_CKY,O++):(r.CHISO_MOI=r.CHISO_MOI&&r.CHISO_MOI.length>0?r.CHISO_MOI:"",r.DMLTYPE="",r.SAN_LUONG=r.SAN_LUONG&&r.SAN_LUONG.length>0?r.SAN_LUONG:"0"),r.TONG=parseFloat(r.SAN_LUONG)+parseFloat(r.SLUONG_TTIEP)+parseFloat(r.SLUONG_THAO),d.push(r)}let G={LST_CHISO:d,LST_LICH:[s],LST_CHISODCN:[]};console.log(d),0!=O?confirm(`C\u1eadp nh\u1eadt ${O} d\xf2ng d\u1eef li\u1ec7u?`)&&(yield e.cmis4SV.ExcuteNhapCSDDK(G).then(V=>{e.plus.alertSuccess()}).catch(V=>{e.plus.alertError("C\xf3 l\u1ed7i x\u1ea3y ra khi c\u1eadp nh\u1eadt d\u1eef li\u1ec7u.")})):e.plus.alertWarning("Kh\xf4ng c\xf3 d\u1eef li\u1ec7u \u0111\u1ec3 c\u1eadp nh\u1eadt.")})()}importRotPLC(a){return this.fbSV.FBS_updateMany(`GCS_CMIS4/${this.kyGCS}`,a)}syncLichGhi(){return this.loadSV.load("syncLichGhi"),this.plus.alertMatSnackBar("\u0110ang \u0111\u1ed3ng b\u1ed9 l\u1ecbch ghi",1e3),this.httpSV.updateLocalDB(this.db,this.apilich,localStorage.getItem("UNIT")+"-"+this.apilich)}save(a){var t=this;return(0,D.Z)(function*(){const e=a.map(i=>({...i,KYCS:t.kyGCS,dateModify:Date.now(),TRANG_THAI:1})),s=`GCS_CMIS4/${t.kyGCS}`;yield t.fbSV.FBS_updateMany(s,e),yield t.idbSV.IDB_DB_Add(t.db,t.api,e)})()}sync(){return this.fbSV.syncFirestoreToIndexedDB(`GCS_CMIS4/${this.kyGCS}`,this.api,this.dbName)}convertPK(a){return"PK0500"+a.padStart(7,"0")}getPhanCong(){this.sheetdbSV.get(this.sheetID,"PhanCong").subscribe(a=>{console.log(a)})}getLichByMaSo(a){var t=this;return(0,D.Z)(function*(){return t.idbSV.IDB_DB_GetAllByIndexKey(t.db,t.apilich,"MA_SOGCS","=",a).then(e=>(console.log(e),e[0]))})()}summarizeData(a){const t=new Map;return a.forEach(e=>{const{MA_SOGCS:s,TEN_TRAM:i,PHAN_CONG:n,CHISO_MOI:o,NGAY_GHI:_}=e;s&&(t.has(s)||t.set(s,{MA_SOGCS:s,TEN_TRAM:i,NGAY_GHI:_,PHAN_CONG:n,SL_GIAO:0,SL_GHI:0}),t.has(s)&&(t.get(s).SL_GIAO+=1),null!=o&&(t.get(s).SL_GHI+=1))}),Array.from(t.values())}exportData(a){const t=new Map;return a.forEach(e=>{const{MA_SOGCS:s,TEN_TRAM:i,PHAN_CONG:n,CHISO_MOI:o}=e;s&&(t.has(s)||t.set(s,{MA_SOGCS:s,TEN_TRAM:i,PHAN_CONG:n,SL_GIAO:0,SL_GHI:0}),t.has(s)&&(t.get(s).SL_GIAO+=1),o&&(t.get(s).SL_GHI+=1))}),Array.from(t.values())}}return c.\u0275fac=function(a){return new(a||c)(E.LFG(v.F),E.LFG(m.a),E.LFG(A.b),E.LFG(T.C),E.LFG(S.F),E.LFG(C.T),E.LFG(B.a))},c.\u0275prov=E.Yz7({token:c,factory:c.\u0275fac,providedIn:"root"}),c})();var u=(()=>{return(c=u||(u={}))[c.CHUA_GHI=0]="CHUA_GHI",c[c.DA_GHI=1]="DA_GHI",u;var c})()},48878:(P,F,l)=>{l.d(F,{C:()=>c});var D=l(15861),I=l(50727),f=l(69751),E=l(78372),v=l(83905),m=l(28986),A=l(15439),T=l.n(A),S=l(94650),C=l(47977),B=l(97185),M=l(94559),u=l(12012),p=l(25555);let c=(()=>{class y{constructor(t,e,s,i,n){this.afs=t,this.toastr=e,this.loadSV=s,this.idbSV=i,this.plus=n,this.subs=new I.w0,this.chunkSize=200}unsub(){this.subs.unsubscribe()}sync(t,e,s){var i=this;return new f.y(n=>{this.idbSV.IDB_InitDB(e).subscribe(function(){var o=(0,D.Z)(function*(_){const g=yield i.idbSV.IDB_GetMax(_,s);let h;return h=g>0?i.afs.collection(t,d=>d.where("dateModify",">",g)):i.afs.collection(t),i.subs=h.valueChanges().pipe((0,E.b)(1e3)).subscribe({next:(d=(0,D.Z)(function*(O){console.log("[syncFirestoreToIndexedDB] New documents to update:",O.length),O.length>0&&(yield i.idbSV.IDB_DB_Add(_,s,O)),n.next(s),console.log("[syncFirestoreToIndexedDB] Update complete.")}),function(G){return d.apply(this,arguments)}),error:d=>{throw console.error("[syncFirestoreToIndexedDB] Error:",d),i._toastWarn("L\u1ed7i khi \u0111\u1ed3ng b\u1ed9 d\u1eef li\u1ec7u! Vui l\xf2ng ki\u1ec3m tra k\u1ebft n\u1ed1i m\u1ea1ng."),d},complete:()=>{console.log("[syncFirestoreToIndexedDB] Sync complete."),n.next(s)}});var d});return function(_){return o.apply(this,arguments)}}())})}syncFirestoreToIndexedDB(t,e,s,i=""){var n=this;return(0,D.Z)(function*(){const o=yield(0,v.z)(n.idbSV.IDB_InitDB(s,i)),_=yield n.idbSV.IDB_GetMax(o,e);let g;return console.log("[syncFirestoreToIndexedDB] Max timestamp from IndexedDB:",_),g=_>0?n.afs.collection(t,h=>h.where("dateModify",">",_)):n.afs.collection(t),n.subs?.unsubscribe(),n.subs=g.valueChanges().pipe((0,E.b)(1e3)).subscribe({next:(h=(0,D.Z)(function*(d){console.log("[syncFirestoreToIndexedDB] New documents to update:",d.length),d.length>0&&(yield n.idbSV.IDB_DB_Add(o,e,d)),console.log("[syncFirestoreToIndexedDB] Update complete.")}),function(O){return h.apply(this,arguments)}),error:h=>{throw console.error("[syncFirestoreToIndexedDB] Error:",h),n.handleError(t,"sync",h),h},complete:()=>{console.log("[syncFirestoreToIndexedDB] Sync complete.")}});var h})()}FBS_set(t,e,s){var i=this;return(0,D.Z)(function*(){let n=i.addBaseProperty(s);return i.loadSV.load("FBS_set"),console.log("FBS_set()",t,e,n),e?i.afs.collection(t).doc(e).set(n).then(o=>{i.loadSV.loaded("FBS_set"),i.logger(t,n,"FBS_set ",!0),i._toastSuccess()}).catch(o=>{i.handleError(t,"FBS_set",o)}):alert("_id kh\xf4ng h\u01a1p l\u1ec7")})()}FBS_setMany(t,e){var s=this;return(0,D.Z)(function*(){if(e.length>1e3)return alert("Vui l\xf2ng thao t\xe1c nh\u1ecf h\u01a1n 1000 d\u1eef li\u1ec7u!");s.loadSV.load("FBS_setMany",t);let i=s.chunkSize,n=[];for(let o=0;o<e.length;o+=i){const _=e.slice(o,o+i);console.log("chunk",_);const g=s.afs.firestore.batch();for(let h=0;h<_.length;h++){const d=_[h],O=s.afs.firestore.collection(t).doc(d._id);g.set(O,s.addBaseProperty(d))}n.push(g.commit()),console.log("FBS_setMany",t,_)}return Promise.allSettled(n).then(o=>{s.logger(t,e,"FBS_setMany ",!0),s.loadSV.loaded("FBS_setMany",t),console.log("FBS_setMany()",t,e)}).catch(o=>{s.loadSV.loaded("FBS_setMany",t),s.handleError(t,"FBS_set",o)})})()}FBS_add(t,e){return new Promise((s,i)=>{let n=this.addBaseProperty(e);n._id=(0,m.h)(25),console.log(" FBS_add",t,n),this.afs.collection(t).doc(n._id).set(n).then(o=>{s(n),this.logger(t,n,"FBS_add ",!0),this._toastSuccess()}).catch(o=>{this.handleError(t,"FBS_add",o)})})}FBS_addMany(t,e){var s=this;return(0,D.Z)(function*(){if(e.length>1e3)return alert("Vui l\xf2ng thao t\xe1c nh\u1ecf h\u01a1n 1000 d\u1eef li\u1ec7u!");s.loadSV.load("FBS_addMany",t);let i=s.chunkSize,n=[];for(let o=0;o<e.length;o+=i){const _=e.slice(o,o+i);console.log("chunk",_);const g=s.afs.firestore.batch();for(let h=0;h<_.length;h++){const d=_[h];d._id=d._id?d._id:(0,m.h)(25);let O=s.addBaseProperty(d);if(O.dateModify=Date.now()+o,!O._id)return alert("_id kh\xf4ng h\u01a1p l\u1ec7");const G=s.afs.firestore.collection(t).doc(O._id);g.set(G,O)}n.push(g.commit()),console.log("FBS_addMany",t,_)}return Promise.all(n).then(o=>{s._toastSuccess(),s.logger(t,e,"FBS_addMany ",!0),s.loadSV.loaded("FBS_addMany",t),console.log("FBS_addMany()",t,e)}).catch(o=>{s.loadSV.loaded("FBS_addMany",t),s.handleError(t,"FBS_addMany",o)})})()}FBS_update(t,e,s){var i=this;return(0,D.Z)(function*(){let n=s;if(n.dateModify=Date.now(),i.loadSV.load("FBS_update",t),!e)return alert("_id kh\xf4ng h\u01a1p l\u1ec7");console.log("FBS_update",t,e,n),yield i.afs.collection(t).doc(e).set(n,{merge:!0}).then(o=>{i._toastSuccess(),i.loadSV.loaded("FBS_update",t),i.logger(t,n,"FBS_update: ",!0)}).catch(o=>{i.loadSV.loaded("FBS_update",t),i.handleError(t,"FBS_update",o)})})()}FBS_updateMany(t,e){var s=this;return(0,D.Z)(function*(){s.loadSV.load("FBS_updateMany",t);const i=Date.now();let n=s.chunkSize,o=[];for(let _=0;_<e.length;_+=n){const g=e.slice(_,_+n);console.log("chunk",g);const h=s.afs.firestore.batch();for(let d=0;d<g.length;d++){let G=g[d];if(!G._id)return alert("_id kh\xf4ng h\u01a1p l\u1ec7");G.dateModify=i+d;const N=s.afs.firestore.collection(t).doc(G._id);h.set(N,G,{merge:!0})}o.push(h.commit()),console.log("FBS_updateMany",t,e)}return Promise.allSettled(o).then(_=>{s._toastSuccess(),s.logger(t,e,"FBS_updateMany ",!0),s.loadSV.loaded("FBS_updateMany",t),console.log("FBS_updateMany()",t,e)}).catch(_=>{s.loadSV.loaded("FBS_updateMany",t),s.handleError(t,"FBS_set",_)})})()}FBS_getById(t,e){return console.log("FBS_getById",t,e),this.logger(t,e,"FBS_getById",null),this.afs.collection(t).doc(e).valueChanges()}FBS_GetByQuery(t,e,s,i){return console.log("FBS_GetByQuery",t,e+s+i),this.logger(t,e+i,"FBS_GetByQuery ",null),this.afs.collection(t,n=>n.where(e,s,i).orderBy(e,"desc")).valueChanges()}FBS_Delete_ID(t,e){return new Promise((s,i)=>{console.log("FBS_Delete_ID()",t,e),this.loadSV.load("FBS_Delete_ID",t),this.afs.collection(t).doc(e).delete().then(n=>{this.logger(t,e,"FBS_Delete_ID ",!0),this.loadSV.loaded("FBS_Delete_ID",t),this._toastSuccess(),s(!0)}).catch(n=>{this.loadSV.loaded("FBS_Delete_ID",t),this.handleError(t,"FBS_Delete_ID"+e,n)})})}FBS_deleteMany(t,e){if(e.length>1e3)return alert("Vui l\xf2ng thao t\xe1c nh\u1ecf h\u01a1n 1000 d\u1eef li\u1ec7u!");this.loadSV.load("FBS_deleteMany",t);let s=this.chunkSize,i=[];for(let n=0;n<e.length;n+=s){const o=e.slice(n,n+s);console.log("chunk",o);const _=this.afs.firestore.batch();for(let g=0;g<o.length;g++){const h=o[g],d=this.afs.firestore.collection(t).doc(h._id);_.delete(d)}i.push(_.commit()),console.log("FBS_updateMany",t,e)}Promise.allSettled(i).then(n=>{this._toastSuccess(),this.logger(t,e,"FBS_updateMany ",!0),this.loadSV.loaded("FBS_deleteMany",t),console.log("FBS_updateMany()",t,e)}).catch(n=>{this.loadSV.loaded("FBS_deleteMany",t),this.handleError(t,"FBS_deleteMany",n)})}FBS_Disable_ID(t,e){var s=this;return(0,D.Z)(function*(){console.log("FBS_Disable_ID()",t,e),confirm("B\u1ea1n mu\u1ed1n x\xf3a?")&&(s.loadSV.load("FBS_Disable_ID",t),s.afs.collection(t).doc(e).update({status:0,dateModify:Date.now()}).then(n=>{console.log(n),s.logger(t,e,"FBS_Delete_ID ",!0),s.loadSV.loaded("FBS_Disable_ID",t)}).catch(n=>{s.loadSV.loaded("FBS_Disable_ID",t),s.handleError(t,"FBS_Disable_ID",n)}))})()}FBS_DisableMany(t,e){this.loadSV.load("FBS_DisableMany",t);let s=this.chunkSize,i=[];for(let n=0;n<e.length;n+=s){const o=e.slice(n,n+s);console.log("chunk",o);const _=this.afs.firestore.batch();for(let g=0;g<o.length;g++){const h=o[g],d=this.afs.firestore.collection(t).doc(h._id);_.update(d,{status:0})}i.push(_.commit()),console.log("FBS_DisableMany",t,e)}Promise.allSettled(i).then(n=>{this._toastSuccess(),this.logger(t,e,"FBS_DisableMany ",!0),this.loadSV.loaded("FBS_DisableMany",t),console.log("FBS_updateMany()",t,e)}).catch(n=>{this.loadSV.loaded("FBS_DisableMany",t),console.error("FBS_DisableMany",t,n),this.logger(t,e,"FBS_DisableMany ERR"+n,!1)})}logger(t,e,s,i=!0){}_toastErr(t=""){this.toastr.error(t),"Missing or insufficient permissions"==t&&this.toastr.error("B\u1ea1n ch\u01b0a \u0111\u01b0\u1ee3c c\u1ea5p quy\u1ec1n truy c\u1eadp!")}_toastSuccess(t=""){this.toastr.success(t,"L\u01b0u th\xe0nh c\xf4ng")}_toastWarn(t=""){this.toastr.warning(t,"C\u1ea3nh b\xe1o")}_setOpt(t,e){this.idbSV.IDB_InitDB("firebase-local").subscribe(s=>{let i=Buffer.from(JSON.stringify(t)).toString("base64");this.idbSV.IDB_DB_Add(s,"any",{_id:t._id+e,module:e,key:i,status:1})})}_getOpt(t=""){return new Promise(e=>{this.idbSV.IDB_InitDB("firebase-local").subscribe(s=>{let i=[],n=null;this.idbSV.IDB_DB_GetAll(s,"any").subscribe(o=>{for(let _=0;_<o.length;_++){let h=JSON.parse(Buffer.from(o[_].key,"base64").toString());o[_].module==t&&(n=h),i.push(h)}t.length>0&&n?e(n):0==t.length&&i.length>0&&e(i)})})})}addBaseProperty(t){return delete t.keyword,t.sync=navigator.onLine?1:0,t.dateModify=Date.now(),t.status=1,t}chunk(t,e){const s=[];for(let i=0;i<t.length;i+=e)s.push(t.slice(i,i+e));return s}handleError(t,e,s){s._id=(0,m.h)(4),this.afs.collection(`logger/${T()().format("YYYY")}/${T()().format("MM")}/${T()().format("DD")}/false`,s),this._toastWarn({unknown:"L\u1ed7i kh\xf4ng x\xe1c \u0111\u1ecbnh","invalid-argument":"Kh\xf4ng th\xe0nh c\xf4ng, vui l\xf2ng th\u1eed l\u1ea1i sau",unauthenticated:"Ch\u01b0a x\xe1c th\u1ef1c, vui l\xf2ng \u0111\u0103ng nh\u1eadp.","data-loss":"D\u1eef li\u1ec7u b\u1ecb l\u1ed7i",unavailable:"L\u1ed7i k\u1ebft n\u1ed1i ho\u1eb7c \u0111\u01b0\u1eddng truy\u1ec1n kh\xf4ng \u1ed5n \u0111\u1ecbnh",internal:"L\u1ed7i kh\xf4ng x\xe1c \u0111\u1ecbnh",cancelled:"Ho\u1ea1t \u0111\u1ed9ng \u0111\xe3 b\u1ecb h\u1ee7y b\u1ecf","deadline-exceeded":"\u0110\xe3 qu\xe1 th\u1eddi h\u1ea1n ph\u1ea3n h\u1ed3i","not-found":"Kh\xf4ng t\xecm th\u1ea5y t\xe0i li\u1ec7u","already-exists":"M\u1ed9t s\u1ed1 t\xe0i li\u1ec7u m\xe0 ch\xfang t\xf4i c\u1ed1 g\u1eafng t\u1ea1o \u0111\xe3 t\u1ed3n t\u1ea1i","permission-denied":"Quy\u1ec1n truy c\u1eadp b\u1ecb t\u1eeb ch\u1ed1i","resource-exhausted":"M\u1ed9t s\u1ed1 t\xe0i nguy\xean \u0111\xe3 c\u1ea1n ki\u1ec7t ho\u1eb7c h\u1ec7 th\u1ed1ng t\u1ec7p \u0111\xe3 h\u1ebft dung l\u01b0\u1ee3ng","failed-precondition":"Thao t\xe1c b\u1ecb t\u1eeb ch\u1ed1i v\xec h\u1ec7 th\u1ed1ng kh\xf4ng \u1edf tr\u1ea1ng th\xe1i c\u1ea7n thi\u1ebft \u0111\u1ec3 th\u1ef1c hi\u1ec7n thao t\xe1c",aborted:"Ho\u1ea1t \u0111\u1ed9ng \u0111\xe3 b\u1ecb h\u1ee7y b\u1ecf","out-of-range":"Thao t\xe1c \u0111\xe3 \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n ngo\xe0i ph\u1ea1m vi h\u1ee3p l\u1ec7",unimplemented:"Ho\u1ea1t \u0111\u1ed9ng kh\xf4ng \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n ho\u1eb7c kh\xf4ng \u0111\u01b0\u1ee3c h\u1ed7 tr\u1ee3/k\xedch ho\u1ea1t"}[s.code])}}return y.\u0275fac=function(t){return new(t||y)(S.LFG(C.ST),S.LFG(B._W),S.LFG(M.b),S.LFG(u.F),S.LFG(p.T))},y.\u0275prov=S.Yz7({token:y,factory:y.\u0275fac,providedIn:"root"}),y})()}}]);